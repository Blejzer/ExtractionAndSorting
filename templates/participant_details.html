{% extends "base.html" %}

{% block title %}Participant Details{% endblock %}

{% macro format_value(value) -%}
  {%- if value is none -%}
    —
  {%- elif value is mapping -%}
    <pre class="mb-0">{{ value | tojson(indent=2) }}</pre>
  {%- elif value is string -%}
    {%- if value | trim -%}
      {{ value }}
    {%- else -%}
      —
    {%- endif -%}
  {%- elif value is iterable and value is not string -%}
    {%- set items = value | list -%}
    {%- if items -%}
      {{ items | join(", ") }}
    {%- else -%}
      —
    {%- endif -%}
  {%- else -%}
    {{ value }}
  {%- endif -%}
{%- endmacro %}

{% block content %}
  <h1 class="mb-4">Participant Details</h1>

  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
        <h2 class="h4 mb-0">{{ visible_details['name'] or 'Unnamed Participant' }}</h2>
        <a
          class="btn btn-primary"
          href="{{ url_for('participants.edit_participant', pid=visible_details['pid'], page=page, search=search, sort=sort, direction=direction) }}"
        >
          ✏️ Edit Participant
        </a>
      </div>

      <table class="table table-bordered mb-0">
        <tbody>
          {% for field in visible_order %}
            <tr>
              <th scope="row" class="w-25 text-capitalize">{{ field_labels[field] }}</th>
              <td>{{ format_value(visible_details[field]) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <button id="toggle-details" class="btn btn-outline-secondary mt-3" type="button">More</button>

      <div id="hidden-details" class="d-none mt-3">
        <h3 class="h5">Additional Information</h3>
        <table class="table table-bordered">
          <tbody>
            {% for field in hidden_order %}
              <tr>
                <th scope="row" class="w-25 text-capitalize">{{ field_labels.get(field, field.replace('_', ' ').title()) }}</th>
                <td>{{ format_value(hidden_details[field]) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <h4 class="mt-4">Events Attended</h4>
  <table
    class="table table-striped mt-2"
    id="events-attended"
    data-details-url-template="{{ url_for('participants.participant_event_details', pid=participant.pid, eid='__EID__') }}"
  >
    <thead>
      <tr>
        <th>Event ID</th>
        <th>Title</th>
        <th>Place</th>
        <th>Country</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th class="text-center">Details</th>
      </tr>
    </thead>
    <tbody>
      {% for event in events %}
        <tr>
          <td>{{ event.eid }}</td>
          <td>{{ event.title }}</td>
          <td>{{ event.place }}</td>
          <td>{{ event.country }}</td>
          <td>{{ event.start_date.strftime('%Y-%m-%d') if event.start_date else '' }}</td>
          <td>{{ event.end_date.strftime('%Y-%m-%d') if event.end_date else '' }}</td>
          <td class="text-center">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              data-action="event-details"
              data-event-id="{{ event.eid }}"
              aria-expanded="false"
            >
              Show details
            </button>
          </td>
        </tr>
        <tr class="event-details d-none" data-event-id="{{ event.eid }}">
          <td colspan="7">
            <div class="event-details-content"></div>
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">No events recorded for this participant.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <a class="btn btn-secondary" href="{{ back_url }}">
    ← Back
  </a>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggleButton = document.getElementById("toggle-details");
      const hiddenSection = document.getElementById("hidden-details");
      if (toggleButton && hiddenSection) {
        toggleButton.addEventListener("click", function () {
          hiddenSection.classList.toggle("d-none");
          if (hiddenSection.classList.contains("d-none")) {
            toggleButton.textContent = "More";
          } else {
            toggleButton.textContent = "Less";
          }
        });
      }

      const eventsTable = document.getElementById("events-attended");
      if (!eventsTable) {
        return;
      }

      const urlTemplate = eventsTable.dataset.detailsUrlTemplate;
      if (!urlTemplate) {
        return;
      }

      const escapeHtml = (value) => {
        return String(value).replace(/[&<>"']/g, (char) => {
          const entities = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          };
          return entities[char] || char;
        });
      };

      const cssEscape = (value) => {
        if (window.CSS && typeof window.CSS.escape === "function") {
          return window.CSS.escape(value);
        }
        return String(value).replace(/[^a-zA-Z0-9_\-]/g, (char) => `\\${char}`);
      };

      const formatDetailValue = (value) => {
        if (value === null || value === undefined) {
          return "&mdash;";
        }
        if (typeof value === "string") {
          const trimmed = value.trim();
          if (!trimmed) {
            return "&mdash;";
          }
          return escapeHtml(trimmed);
        }
        return escapeHtml(value);
      };

      eventsTable.addEventListener("click", function (event) {
        const button = event.target.closest("button[data-action='event-details']");
        if (!button) {
          return;
        }

        const eventId = button.dataset.eventId;
        if (!eventId) {
          return;
        }

        const detailsRow = eventsTable.querySelector(
          `tr.event-details[data-event-id="${cssEscape(eventId)}"]`
        );
        if (!detailsRow) {
          return;
        }

        const contentCell = detailsRow.querySelector(".event-details-content");
        const isVisible = !detailsRow.classList.contains("d-none");
        if (isVisible) {
          detailsRow.classList.add("d-none");
          button.setAttribute("aria-expanded", "false");
          button.textContent = "Show details";
          return;
        }

        const showRow = () => {
          detailsRow.classList.remove("d-none");
          button.setAttribute("aria-expanded", "true");
          button.textContent = "Hide details";
        };

        if (detailsRow.dataset.loaded === "true") {
          showRow();
          return;
        }

        if (contentCell) {
          contentCell.innerHTML = '<span class="text-muted">Loading…</span>';
        }
        button.disabled = true;

        const url = urlTemplate.replace("__EID__", encodeURIComponent(eventId));
        fetch(url, { headers: { Accept: "application/json" } })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to load details");
            }
            return response.json();
          })
          .then((payload) => {
            if (!contentCell) {
              return;
            }

            const available = payload && Object.prototype.hasOwnProperty.call(payload, "available")
              ? Boolean(payload.available)
              : true;

            const details = Array.isArray(payload && payload.details) ? payload.details : [];

            if (!available) {
              contentCell.innerHTML = '<span class="text-muted">No additional details available for this event.</span>';
            } else if (!details.length) {
              contentCell.innerHTML = '<span class="text-muted">No additional details provided.</span>';
            } else {
              const rows = details
                .map((item) => {
                  const label = escapeHtml(item && item.label ? item.label : item.field || "Detail");
                  const value = formatDetailValue(item ? item.value : null);
                  return `<tr><th scope="row" class="w-25">${label}</th><td>${value}</td></tr>`;
                })
                .join("");
              contentCell.innerHTML = `
                <div class="table-responsive">
                  <table class="table table-sm table-bordered mb-0">
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              `;
            }

            detailsRow.dataset.loaded = "true";
            showRow();
          })
          .catch(() => {
            if (contentCell) {
              contentCell.innerHTML = '<span class="text-danger">Unable to load event details. Please try again.</span>';
            }
          })
          .finally(() => {
            button.disabled = false;
          });
      });
    });
  </script>
{% endblock %}
